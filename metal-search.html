<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Добавление металла / неметалла</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .threeColumns {
            display: flex;
            justify-content: space-between;
            flex-direction: row;
            align-items: center;
            gap: 10px; 
        }

        .textFor {
            width: 25%;
            text-align: center;
        }

        .rightInputTwo {
            width: 62.5%;
        }
        .topTextForm {
            margin-bottom: 10px;
        }

        .button {
            margin-bottom: 10px;
        }

        .mtlp, .topTextForm {
            text-align: center;
            font-weight: bold;
        }

        .topText {
            margin-bottom: 10px;
            font-size: var(--cellHeader);
        }

        .normalInput {
            width: 100%;
        }

        .tk {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .leftText, .rightInput {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .tk:last-of-type {
            margin-bottom: 0;
        }

        .rightInput {
            width: 25%;
        }

        h1 {
            margin: 0;
        }

        .submit {
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="forForm">
    <form id="metalForSearch">
        <div class="container head">
            <h1>Параметры поиска Металл / Неметалл</h1>
        </div>

        <div class="container mtlp startSearch">
            <h2>Поиск по:</h2>
            <select id="searchBy" class="selectType forH2Select">
                <option value="parameters">Параметрам</option>
                <option value="rnNumber">По номеру РН</option>
            </select>
        </div>

        <div id="parameters">

            <div class="container mtlp">
                <label for="material" class="topText">Тип материала:</label>
                    <select id="material" class="selectType">
                        <option value="Металл">Металл</option>
                        <option value="Неметалл">Неметалл</option>
                    </select>
            </div>

                <!-- Металлы марка-->

            <div class="container mtlp" id="metalFields">
                <label for="steelGrade" class="topText">Марка:</label>
                <input type="text" id="steelGrade" class="normalInput" placeholder="Выбери или введи свой вариант" list="steelGradeList" autocomplete="off">
                <datalist id="steelGradeList">
                    <option value="Сталь 30">Сталь 30</option>
                    <option value="Сталь 45">Сталь 45</option>
                    <option value="Сталь 40Х">Сталь 40Х</option>
                    <option value="Сталь 30ХГСА">Сталь 30ХГСА</option>
                    <option value="Сталь 65Г">Сталь 65Г</option>
                    <option value="Сталь 60С2А">Сталь 60С2А</option>
                    <option value="Сталь ХВГ">Сталь ХВГ</option>
                    <option value="08Х18Н10Т / AISI304">08Х18Н10Т / AISI304</option>
                    <option value="12Х18Н10Т">12Х18Н10Т</option>
                    <option value="14Х17">14Х17</option>
                    <option value="30Х13">30Х13</option>
                    <option value="40Х13 / AISI420">40Х13 / AISI420</option>
                    <option value="АмЦ">АмЦ</option>
                    <option value="Ал6">Ал6</option>
                    <option value="Ал8">Ал8</option>
                    <option value="Д16Т">Д16Т</option>
                    <option value="БрОЦ5-5-5">БрОЦ5-5-5</option>
                    <option value="БрКМЦ3-1">БрКМЦ3-1</option>
                    <option value="БрАж">БрАж</option>
                    <option value="БрБ2Б">БрБ2Б</option>
                    <option value="ЛС59">ЛС59</option>
                    <option value="М3">М3</option>
                    <option value="М1">М1</option>
                    <option value="ОТ-4">ОТ-4</option>
                    <option value="ВТ-1">ВТ-1</option>
                    <option value="ВТ-14">ВТ-14</option>
                    <option value="Grade5">Grade5</option>
                    <option value="ВТ-22">ВТ-22</option>
                </datalist>
            </div>

                <!-- Марка неметалла -->

            <div class="container mtlp" id="polymerFields" style="display:none;">
                <label for="polymerType" class="topText">Марка:</label>
                <input type="text" id="polymerType" list="polymerTypeList" placeholder="Выбери или введи свой вариант" class="normalInput" autocomplete="off">
                <datalist id="polymerTypeList">
                    <option value="ПТ1">ПТ1</option>
                    <option value="Ф-4">Ф-4</option>
                    <option value="Пб6">Пб6</option>
                    <option value="РЕЕК GF30">РЕЕК GF30</option>
                </datalist>
            </div>

                <!-- Сортамент металла -->

            <div class="container mtlp" id="metalAssortment">
                <label for="assortmentSteel" class="topText">Сортамент:</label>
                <input type="text" id="assortmentSteel" class="normalInput" placeholder="Выбери или введи свой вариант" list="assortmentListSteel" autocomplete="off">
                <datalist id="assortmentListSteel">
                    <option value="Круг">Круг</option>
                    <option value="Квадрат">Квадрат</option>
                    <option value="Полоса">Полоса</option>
                    <option value="Листовой металл">Листовой металл</option>
                    <option value="Проволока">Проволока</option>
                    <option value="Труба">Труба</option>
                    <option value="Стержень">Стержень</option>
                </datalist>
            </div>

            <!-- Сортамент неметалла -->

            <div class="container mtlp" id="polymerAssortment" style="display:none;">
                <label for="assortmentPolymer" class="topText">Сортамент:</label>
                <input type="text" id="assortmentPolymer" class="normalInput" placeholder="Выбери или введи свой вариант" list="assortmentListPolymer" autocomplete="off">
                <datalist id="assortmentListPolymer">
                    <option value="Стержень">Стержень</option>
                </datalist>
            </div>

            <div class="container">
                <div class="threeColumns">
                    <label for="inStockSearch">Только в наличии</label>
                    <input type="checkbox" id="inStockSearch" class="rightInput">
                </div>
            </div>
        </div>

        <div id="numberNR" style="display: none">

            <div class="container mtlp">
                <label for="numberRNSearch" class="topText">По номеру РН</label>
                <input  type="text" class="normalInput" id="numberRNSearch" placeholder="002284" autocomplete="off">
            </div>

        </div>
        <button type="submit" class="button search" >Поиск</button>
    </form>
        <button type="button" class="button submit" id="resetBtn">Сброс</button>
        <button class="button back" id="backButton" onclick="back()">Назад</button>
    
    <script>
    const searchSelect = document.getElementById('searchBy');
    const parametersForSearch = document.getElementById('parameters');
    const numberNRSearch = document.getElementById('numberNR');

    const materialSelect = document.getElementById('material');
    const metalFields = document.getElementById('metalFields');
    const polymerFields = document.getElementById('polymerFields');
    const assortmentSteel = document.getElementById('metalAssortment');
    const assortmentPolymer = document.getElementById('polymerAssortment');

    const form = document.getElementById("metalForSearch");

    function setDisabled(container, disabled) {
        container.querySelectorAll('input, select, textarea').forEach(el => {
            el.disabled = disabled;
        });
    }

    function hideBlock(block) {
        block.style.display = 'none';
        setDisabled(block, true);
    }

    function showBlock(block) {
        block.style.display = 'block';
        setDisabled(block, false);
    }

    function updateVisibility() {
        // Сначала скрываем всё
        hideBlock(parametersForSearch);
        hideBlock(numberNRSearch);

        hideBlock(metalFields);
        hideBlock(polymerFields);
        hideBlock(assortmentSteel);
        hideBlock(assortmentPolymer);

        // Режим поиска
        if (searchSelect.value === "parameters") {
            showBlock(parametersForSearch);

            // Тип материала
            if (materialSelect.value === 'Металл') {
                showBlock(metalFields);
                showBlock(assortmentSteel);
            }

            if (materialSelect.value === 'Неметалл') {
                showBlock(polymerFields);
                showBlock(assortmentPolymer);
            }
        }

        if (searchSelect.value === "rnNumber") {
            showBlock(numberNRSearch);
        }
    }

    function clearInputs(container) {
        container.querySelectorAll('input').forEach(input => {
            if (input.type === 'checkbox') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
    }


    searchSelect.addEventListener('change', () => {
        clearInputs(parametersForSearch);
        clearInputs(numberNRSearch);
        updateVisibility();
    });

    materialSelect.addEventListener('change', () => {
        clearInputs(parametersForSearch);
        updateVisibility();
    });


    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        await search();
    });

        // Пишем функции ВНЕ всяких других функций, прямо в корне <script>
    window.hideExcelRow = async function(rowNumber) {
        console.log("Попытка скрыть строку:", rowNumber);
        try {
            await Excel.run(async (context) => {
                const sheet = context.workbook.worksheets.getActiveWorksheet();
                const range = sheet.getRange(`${rowNumber}:${rowNumber}`);
                range.rowHidden = true;
                await context.sync();
                console.log(`✅ Строка ${rowNumber} скрыта в Excel`);
            });
        } catch (err) {
            console.error("Ошибка Excel. Проверьте название листа (должно быть 'rings'):", err);
        }
    };

    window.showAll = async function() {
        try {
            await Excel.run(async (context) => {
                context.workbook.worksheets.getActiveWorksheet().getUsedRange().rowHidden = false;
                await context.sync();
                console.log("✅ Все строки открыты");
            });
        } catch (err) {
            console.error("Ошибка при показе строк:", err);
        }
    };

    // Инициализация Office (пустая, просто чтобы аддон не падал)
    Office.onReady((info) => {
        if (info.host === Office.HostType.Excel) {
            console.log("Office готов, хост: Excel");
            // Вызываем функцию, которая реально существует в коде ниже
            getAllRows();
    }

    });

    let metalDatabase = [];



    async function getAllRows() {
        try {
            await Excel.run(async (context) => {

                const sheet = context.workbook.worksheets.getActiveWorksheet();
                const usedRange = sheet.getUsedRange();

                usedRange.load("values");
                await context.sync();

                const values = usedRange.values;

                if (!values || values.length < 2) {
                    console.warn("Таблица пуста или содержит мало данных");
                    metalDatabase = null;
                    return;
                }

                // Убираем первую строку (служебную, если она есть)
                // Оставляем: [заголовки + данные]
                metalDatabase = values.slice(2);

                console.log("metalDatabase:", metalDatabase);
            });
        } catch (error) {
            console.error("Ошибка Excel:", error.debugInfo || error);
        }
    }

    async function search() {

    await window.showAll();

    if (searchSelect.value === "rnNumber") {

    const rn = String(document.getElementById("numberRNSearch").value).trim();

        if (!rn) {
            console.warn("Пожалуйста, введите номер РН для поиска.");
            return;
        }

    console.log("Начинаю поиск РН:", rn);

    let count = 3;

        for (let char of metalDatabase) {
            if (String(char[7] || "").trim() !== rn) {
                await window.hideExcelRow(count);
            }
            count++;
        }

    } else if (searchSelect.value === "parameters") {

    // ===== ПОИСК ПО ПАРАМЕТРАМ =====

    const inStock = document.getElementById("inStockSearch").checked;

    const material = document.getElementById("material").value.trim();

    const stell = document.getElementById("steelGrade").value.trim() || document.getElementById("polymerType").value.trim() || null;

    const assortment = document.getElementById("assortmentSteel").value.trim() || document.getElementById("assortmentPolymer").value.trim() || null;


    let count = 3;
        for (let char of metalDatabase) {

            if (inStock) {
                const qty = Number(char[6]) || 0;
                if (qty <= 0) {
                    await window.hideExcelRow(count);
                    count++;
                    continue;
                }
            }

            if (material) {
                if (material !== char[1]) {
                    await window.hideExcelRow(count);
                    count++;
                    continue;
                }
            }

            if (stell) {
                if (stell !== char[9]) {
                    await window.hideExcelRow(count);
                    count++;
                    continue;
                }
            }

            if (assortment) {
                if (assortment !== char[10]) {
                    await window.hideExcelRow(count);
                    count++;
                    continue;
                }
            }
            count++;
        }
    }

    };
    
    const reset = document.getElementById("resetBtn");

    reset.addEventListener("click", async (event) => {
        event.preventDefault();
        await window.showAll();
    });

    function back() {
        window.location.href = "taskpane.html";
    }

    updateVisibility();
</script>

</body>
<footer>
  <p class="footer">
    © 2026 Михаил Полтавский
    <span class="dot">·</span>
    Мой GitHub —
    <a href="https://github.com/Bentor48"
       target="_blank"
       rel="noopener noreferrer"
       class="github-link"
       aria-label="Мой GitHub">

      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
           xmlns="http://www.w3.org/2000/svg">
        <path d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.11 3.29 9.45 7.86 10.98.58.11.79-.25.79-.56
        0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54
        -.53-1.36-1.3-1.72-1.3-1.72
        -1.06-.73.08-.72.08-.72
        1.17.08 1.79 1.2 1.79 1.2
        1.04 1.78 2.73 1.27 3.4.97
        .11-.75.41-1.27.74-1.56
        -2.56-.29-5.26-1.28-5.26-5.69
        0-1.26.45-2.29 1.19-3.1
        -.12-.29-.52-1.46.11-3.05
        0 0 .97-.31 3.18 1.18
        .92-.26 1.9-.39 2.88-.39
        .98 0 1.96.13 2.88.39
        2.2-1.49 3.18-1.18 3.18-1.18
        .63 1.59.23 2.76.11 3.05
        .74.81 1.19 1.84 1.19 3.1
        0 4.42-2.7 5.39-5.27 5.67
        .42.36.8 1.08.8 2.18
        0 1.57-.01 2.84-.01 3.23
        0 .31.21.68.8.56
        4.57-1.53 7.85-5.87 7.85-10.98
        C23.5 5.74 18.27.5 12 .5z"/>
      </svg>
    </a>
  </p>
</footer>
</html>