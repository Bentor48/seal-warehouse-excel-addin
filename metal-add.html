<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Добавление металла / неметалла</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .mtlp, .topTextForm {
            text-align: center;
            font-weight: bold;
        }

        .topText {
            margin-bottom: 10px;
            font-size: var(--cellHeader);
        }

        .normalInput {
            width: 100%;
        }

        .tk {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .leftText, .rightInput {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .tk:last-of-type {
            margin-bottom: 0;
        }

        .rightInput {
            width: 25%;
        }

        h1 {
            margin: 0;
        }

        .submit {
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="forForm">
    <form id="materialForm" onsubmit="send(event)">
        <div class="container head">
            <h1>Металл / Неметалл</h1>
        </div>

        <div class="container mtlp">
            <label for="material" class="topText">Тип материала:</label>
            <select id="material" class="selectType" required>
                <option value="Металл">Металл</option>
                <option value="Неметалл">Неметалл</option>
            </select>
        </div>

        <!-- Металлы марка-->

        <div class="container mtlp" id="metalFields">
            <label for="steelGrade" class="topText">Марка:</label>
            <input type="text" id="steelGrade" class="normalInput" required placeholder="Выбери или введи свой вариант" list="steelGradeList" autocomplete="off">
            <datalist id="steelGradeList">
                <option value="Сталь 30">Сталь 30</option>
                <option value="Сталь 45">Сталь 45</option>
                <option value="Сталь 40Х">Сталь 40Х</option>
                <option value="Сталь 30ХГСА">Сталь 30ХГСА</option>
                <option value="Сталь 65Г">Сталь 65Г</option>
                <option value="Сталь 60С2А">Сталь 60С2А</option>
                <option value="Сталь ХВГ">Сталь ХВГ</option>
                <option value="08Х18Н10Т / AISI304">08Х18Н10Т / AISI304</option>
                <option value="12Х18Н10Т">12Х18Н10Т</option>
                <option value="14Х17">14Х17</option>
                <option value="30Х13">30Х13</option>
                <option value="40Х13 / AISI420">40Х13 / AISI420</option>
                <option value="АмЦ">АмЦ</option>
                <option value="Ал6">Ал6</option>
                <option value="Ал8">Ал8</option>
                <option value="Д16Т">Д16Т</option>
                <option value="БрОЦ5-5-5">БрОЦ5-5-5</option>
                <option value="БрКМЦ3-1">БрКМЦ3-1</option>
                <option value="БрАж">БрАж</option>
                <option value="БрБ2Б">БрБ2Б</option>
                <option value="ЛС59">ЛС59</option>
                <option value="М3">М3</option>
                <option value="М1">М1</option>
                <option value="ОТ-4">ОТ-4</option>
                <option value="ВТ-1">ВТ-1</option>
                <option value="ВТ-14">ВТ-14</option>
                <option value="Grade5">Grade5</option>
                <option value="ВТ-22">ВТ-22</option>
            </datalist>
        </div>

        <!-- Марка неметалла -->

        <div class="container mtlp" id="polymerFields" style="display:none;">
            <label for="polymerType" class="topText">Марка:</label>
            <input type="text" id="polymerType" list="polymerTypeList" placeholder="Выбери или введи свой вариант" class="normalInput" required autocomplete="off">
            <datalist id="polymerTypeList">
                <option value="ПТ1">ПТ1</option>
                <option value="Ф-4">Ф-4</option>
                <option value="Пб6">Пб6</option>
                <option value="РЕЕК GF30">РЕЕК GF30</option>
            </datalist>
        </div>

        <!-- Сортамент металла -->

        <div class="container mtlp" id="metalAssortment">
            <label for="assortmentSteel" class="topText">Сортамент:</label>
            <input type="text" id="assortmentSteel" class="normalInput" placeholder="Выбери или введи свой вариант" list="assortmentListSteel" required autocomplete="off">
            <datalist id="assortmentListSteel">
                <option value="Круг">Круг</option>
                <option value="Квадрат">Квадрат</option>
                <option value="Полоса">Полоса</option>
                <option value="Листовой металл">Листовой металл</option>
                <option value="Проволока">Проволока</option>
                <option value="Труба">Труба</option>
                <option value="Стержень">Стержень</option>
            </datalist>
        </div>

        <!-- Сортамент неметалла -->

        <div class="container mtlp" id="polymerAssortment" style="display:none;">
            <label for="assortmentPolymer" class="topText">Сортамент:</label>
            <input type="text" id="assortmentPolymer" class="normalInput" placeholder="Выбери или введи свой вариант" list="assortmentListPolymer" required autocomplete="off">
            <datalist id="assortmentListPolymer">
                <option value="Стержень">Стержень</option>
            </datalist>
        </div>

        <div class="container tk">
            <label for="quantity" class="leftText">Количество:</label>

            <select id="typeListQuantity" class="selectType rightInput" required>
                <option value="Кг">Кг</option>
                <option value="М">М</option>
                <option value="Т">Т</option>
                <option value="Шт">Шт</option>
            </select>

            <input type="number" id="quantity" required min="1" class="rightInput">
        </div>



        <div class="container mtlp">
            <label for="link" class="topText">Ссылка на РН</label>
            <input  type="url" required class="normalInput" id="link" placeholder="Вставить из проводника. Пример - C:\RN\2026\RN-123.pdf" autocomplete="off">
        </div>

        <div class="container mtlp">
            <label for="numberRN" class="topText">Номер РН</label>
            <input  type="text" required class="normalInput" id="numberRN" placeholder="002284" autocomplete="off">
        </div>

        <div class="container mtlp">
              <label for="storage" class="topText">Хранение:</label>
              <input type="text" id="storage" class="normalInput" required placeholder="Выбери или введи свой вариант" list="storageLocation" autocomplete="off">
              <datalist id="storageLocation">
                <option value="Склад УСГФ">Склад УСГФ</option>
              </datalist>
        </div>

        <div class="container mtlp">
            <label for="note" class="topText">Примечание</label>
            <textarea id="note" placeholder="Не обязательно"></textarea>
        </div>

        <button type="submit" class="button submit">Сохранить</button>
    </form>
        <button class="button back" id="backButton" onclick="back()">Назад</button>
    
    <script>
        // Переключение полей в зависимости от выбора материала
        const materialSelect = document.getElementById('material');
        const metalFields = document.getElementById('metalFields');
        const polymerFields = document.getElementById('polymerFields');
        const assortmentSteel = document.getElementById('metalAssortment');
        const assortmentPolymer = document.getElementById('polymerAssortment');

        function setDisabled(container, disabled) {
            const inputs = container.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = disabled;
            });
        }

        materialSelect.addEventListener('change', () => {
            // Скрываем и отключаем всё
            metalFields.style.display = 'none';
            polymerFields.style.display = 'none';
            assortmentSteel.style.display = 'none';
            assortmentPolymer.style.display = 'none';
            setDisabled(metalFields, true);
            setDisabled(polymerFields, true);
            setDisabled(assortmentSteel, true);
            setDisabled(assortmentPolymer, true);

            // Включаем нужный блок
            if (materialSelect.value === 'Металл') {
            metalFields.style.display = 'block';
            assortmentSteel.style.display = 'block';
            setDisabled(metalFields, false);
            setDisabled(assortmentSteel, false);
            }

            if (materialSelect.value === 'Неметалл') {
            polymerFields.style.display = 'block';
            assortmentPolymer.style.display = 'block';
            setDisabled(polymerFields, false);
            setDisabled(assortmentPolymer, false);
            }
        });

        const quantityType = document.getElementById('typeListQuantity');
        const quantityInput = document.getElementById('quantity');

        function updateQuantityInput() {
            if (quantityType.value === 'Шт') {
                quantityInput.step = '1';     // только целые
                quantityInput.value = Math.floor(quantityInput.value || 1);
            } else {
            quantityInput.step = 'any';  // любое количество знаков после запятой
            quantityInput.min = '0';
            }
        }

        quantityType.addEventListener('change', updateQuantityInput);
        updateQuantityInput(); // начальная установка


        let officeReady = false;

        Office.onReady((info) => {
            if (info.host === Office.HostType.Excel) {
            officeReady = true;
            console.log("Office готов");
            }
        });

        //Проверка и очистка невидимых символов в ссылке
        function cleanHiddenChars(str) {
            if (!str) return str;
            return str.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, '');
        }

        let isSaving = false;

        async function send(event) {
            event.preventDefault();
            if (!officeReady) {
            alert("Office ещё не готов. Подождите секунду.");
            return false;
        }

        const button = document.querySelector("button[type='submit']");
        if (isSaving) return false;
        isSaving = true;

        button.disabled = true;
        button.innerText = "Сохранение...";

        try {
            await Excel.run(async (context) => {
            const sheet = context.workbook.worksheets.getActiveWorksheet();

        // всегда 3-я строка (index = 2)
        const insertRowIndex = 2;

        function metalOrPolymer() {
            if (materialSelect.value === 'Металл') {
            return "Металл";
            } else
            return "Неметалл";
        }

        const material = metalOrPolymer();
        const tons = quantityType.value === "Т" ? quantity.value : null;
        const kilograms = quantityType.value === "Кг" ? quantity.value : null;
        const piece = quantityType.value === "Шт" ? quantity.value : null;
        const meters = quantityType.value === "М" ? quantity.value : null;
        const type = material === "Металл" ?  steelGrade.value : polymerType.value;
        const assortment = material === "Металл" ? document.getElementById("assortmentSteel").value : document.getElementById("assortmentPolymer").value;

        link.value = cleanHiddenChars(link.value);

        // формируем строку ДО Excel-операций
        const row = [
            new Date(),
            material,
            kilograms,
            tons,
            meters,
            piece,
            quantity.value,
            numberRN.value,
            link.value,
            type,
            assortment,
            storage.value,
            note.value ? `Примечание: ${note.value}` : "Примечание: отсутствует"
        ];

        // вставляем строку
        const usedRange = sheet.getUsedRange();
        usedRange.load("columnCount");
        await context.sync();

        // 1. Вставляем строку
        sheet
            .getRangeByIndexes(insertRowIndex, 0, 1, usedRange.columnCount)
            .insert(Excel.InsertShiftDirection.down);

        // 2. Форматы
        sheet.getRangeByIndexes(insertRowIndex, 1, 1, 1).numberFormat = [["@"]];
        sheet.getRangeByIndexes(insertRowIndex, 7, 1, 1).numberFormat = [["@"]];
        sheet.getRangeByIndexes(insertRowIndex, 9, 1, 1).numberFormat = [["@"]];
        sheet.getRangeByIndexes(insertRowIndex, 10, 1, 1).numberFormat = [["@"]];
        sheet.getRangeByIndexes(insertRowIndex, 11, 1, 1).numberFormat = [["@"]];

        // 3. Данные
        sheet
            .getRangeByIndexes(insertRowIndex, 0, 1, row.length)
            .values = [row];
        });

        document.getElementById("materialForm").reset();
        materialSelect.dispatchEvent(new Event("change"));

        let seconds = 5;
        button.innerText = `Готово ✔ ${seconds}`;

        const timer = setInterval(() => {
        seconds--;
        button.innerText = `Готово ✔ ${seconds}`;
        if (seconds <= 0) {
            clearInterval(timer);
            button.disabled = false;
            button.innerText = "Сохранить";
            isSaving = false;
            }
        }, 1000);

        } catch (error) {
        console.error(error);
        button.disabled = false;
        button.innerText = "Сохранить";
        isSaving = false;
        alert("Ошибка при сохранении (см. консоль)");
    }
    return false;
}


  function back() {
        window.location.href = "taskpane.html";
    }

    materialSelect.dispatchEvent(new Event("change"));

    </script>
</body>
<footer>
  <p class="footer">
    © 2026 Михаил Полтавский
    <span class="dot">·</span>
    Мой GitHub —
    <a href="https://github.com/Bentor48"
       target="_blank"
       rel="noopener noreferrer"
       class="github-link"
       aria-label="Мой GitHub">

      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
           xmlns="http://www.w3.org/2000/svg">
        <path d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.11 3.29 9.45 7.86 10.98.58.11.79-.25.79-.56
        0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54
        -.53-1.36-1.3-1.72-1.3-1.72
        -1.06-.73.08-.72.08-.72
        1.17.08 1.79 1.2 1.79 1.2
        1.04 1.78 2.73 1.27 3.4.97
        .11-.75.41-1.27.74-1.56
        -2.56-.29-5.26-1.28-5.26-5.69
        0-1.26.45-2.29 1.19-3.1
        -.12-.29-.52-1.46.11-3.05
        0 0 .97-.31 3.18 1.18
        .92-.26 1.9-.39 2.88-.39
        .98 0 1.96.13 2.88.39
        2.2-1.49 3.18-1.18 3.18-1.18
        .63 1.59.23 2.76.11 3.05
        .74.81 1.19 1.84 1.19 3.1
        0 4.42-2.7 5.39-5.27 5.67
        .42.36.8 1.08.8 2.18
        0 1.57-.01 2.84-.01 3.23
        0 .31.21.68.8.56
        4.57-1.53 7.85-5.87 7.85-10.98
        C23.5 5.74 18.27.5 12 .5z"/>
      </svg>
    </a>
  </p>
</footer>
</html>